<!DOCTYPE html>
<html lang="en">


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>
<script
  type="text/javascript"
  charset="utf-8"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
>
</script>
<script
  type="text/javascript"
  charset="utf-8"
  src="https://vincenttam.github.io/javascripts/MathJaxLocal.js"
>
</script>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Memory Management | LFMUNOZ</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Memory Management" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="articles, notes, and references" />
<meta property="og:description" content="articles, notes, and references" />
<link rel="canonical" href="lfmunoz.github.io/documents/books/C/MemoryManagement.html" />
<meta property="og:url" content="lfmunoz.github.io/documents/books/C/MemoryManagement.html" />
<meta property="og:site_name" content="LFMUNOZ" />
<script type="application/ld+json">
{"@type":"WebPage","headline":"Memory Management","url":"lfmunoz.github.io/documents/books/C/MemoryManagement.html","description":"articles, notes, and references","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/documents/assets/main.css"><link type="application/atom+xml" rel="alternate" href="lfmunoz.github.io/documents/feed.xml" title="LFMUNOZ" /></head>
<body><header class="site-header" role="banner">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2YJDWQX6GK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-2YJDWQX6GK');
  </script>

  <div class="wrapper"><a class="site-title" rel="author" href="/documents/">LFMUNOZ</a><nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path
              d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
          </svg>
        </span>
      </label>

      <div class="trigger"><a class="page-link" href="/documents/about/">About</a></div>
    </nav></div>
</header><div class="main"><div class="column-sidebar">

    <div class="nav-section">
        <div class="nav-title">Posts</div><div class="post-container"><a class="post-link" href="/documents/2020/12/17/i-wish-i-was-worse.html"> I wish I was worse at dancing</a>
            <span class="post-meta">Dec 17, 2020</span>
        </div><div class="post-container"><a class="post-link" href="/documents/2020/12/13/too-many-options.html"> Too many options slows production</a>
            <span class="post-meta">Dec 13, 2020</span>
        </div><div class="post-container"><a class="post-link" href="/documents/2020/12/06/dream-cats-and-dogs.html"> A dream of dogs and cats</a>
            <span class="post-meta">Dec 6, 2020</span>
        </div><div class="post-container"><a class="post-link" href="/documents/2020/11/27/http-rest-bad-design.html"> RESTful HTTP creates coupling</a>
            <span class="post-meta">Nov 27, 2020</span>
        </div><div class="post-container"><a class="post-link" href="/documents/2020/08/01/organization-and-structure.html"> Organization and Structure of Applications</a>
            <span class="post-meta">Aug 1, 2020</span>
        </div><div class="post-container"><a class="post-link" href="/documents/2020/07/12/listening-to-music.html"> Listening to Music</a>
            <span class="post-meta">Jul 12, 2020</span>
        </div><div class="post-container"><a class="post-link" href="/documents/2020/07/05/frameworks.html"> Frameworks and Libraries</a>
            <span class="post-meta">Jul 5, 2020</span>
        </div><p class="rss-subscribe">subscribe <a href="/documents/feed.xml">via RSS</a></p>
    </div>

    <div class="nav-section">
        <div class="nav-title">Guides</div>
        <ul>
            
            <li>
                <strong> Computer Science</strong>
                <ul>
                    
                    <li><a href="/documents/books/Algorithms/Introduction.html">Algorithms</a></li>
                    
                    <li><a href="/documents/articles/SoftwareEngineering.html">Software Engineering</a></li>
                    
                    <li><a href="/documents/books/DesignPatterns.html">Design Patterns</a></li>
                    
                    <li><a href="/documents/books/Linux/Introduction.html">Linux</a></li>
                    
                    <li><a href="/documents/books/Databases/Introduction.html">Databases</a></li>
                    
                    <li><a href="/documents/books/SoftwareEngineering/Concurrency.html">Concurrency</a></li>
                    
                    <li><a href="/documents/books/Security/Introduction.html">Security</a></li>
                    
                </ul>
            </li>

            
            <li>
                <strong> Programming Languages</strong>
                <ul>
                    
                    <li><a href="/documents/books/C/Introduction.html">C</a></li>
                    
                    <li><a href="/documents/books/Cpp/Introduction.html">C++</a></li>
                    
                    <li><a href="/documents/books/Rust/Introduction.html">Rust</a></li>
                    
                    <li><a href="/documents/books/Go/Introduction.html">Go</a></li>
                    
                    <li><a href="/documents/books/Java/Introduction.html">Java</a></li>
                    
                    <li><a href="/documents/books/Kotlin/Introduction.html">Kotlin</a></li>
                    
                    <li><a href="/documents/lang/Python/Introduction.html">Python</a></li>
                    
                    <li><a href="/documents/lang/Bash/Introduction.html">Bash</a></li>
                    
                    <li><a href="/documents/books/Make/Introduction.html">Makefile</a></li>
                    
                    <li><a href="/documents/lang/SQL/Introduction.html">SQL</a></li>
                    
                    <li><a href="/documents/lang/HTML/Introduction.html">HTML</a></li>
                    
                </ul>
            </li>

            
            <li>
                <strong> Technologies</strong>
                <ul>
                    
                    <li><a href="/documents/tech/Android/Introduction.html">Android</a></li>
                    
                    <li><a href="/documents/books/Docker/Introduction.html">Docker</a></li>
                    
                    <li><a href="/documents/books/Envoy/Introduction.html">Envoy</a></li>
                    
                    <li><a href="/documents/books/Terraform/Introduction.html">Terraform</a></li>
                    
                </ul>
            </li>

            
            <li>
                <strong> Mathematics</strong>
                <ul>
                    
                    <li><a href="/documents/mathematics/Foundations.html">Foundations</a></li>
                    
                    <li><a href="/documents/books/Logic/Introduction.html">Logic</a></li>
                    
                    <li><a href="/documents/books/SetTheory/Introduction.html">Set Theory</a></li>
                    
                    <li><a href="/documents/books/Geometry/Introduction.html">Geometry</a></li>
                    
                    <li><a href="/documents/books/Analysis/Introduction.html">Analysis</a></li>
                    
                </ul>
            </li>

            
            <li>
                <strong> Miscellaneous</strong>
                <ul>
                    
                    <li><a href="/documents/books/Non-Duality/Introduction.html">Non-Duality</a></li>
                    
                </ul>
            </li>

            
        </ul>
    </div>


</div><div class="column-main">
            <main class="page-content" aria-label="Content">
                <div class="wrapper">
                    <h1 id="memory-management">Memory Management</h1>

<ul>
  <li><a href="Introduction.html">The C Programming Language</a></li>
</ul>

<p>C provides several functions for memory allocation and management also known as dynamic memory allocation.</p>

<ul>
  <li>malloc and calloc, to reserve space, on the heap</li>
  <li>realloc, to move a reserved block of memory to another allocation of different dimensions</li>
  <li>free, to release space back to C</li>
</ul>

<p>tip: When you allocate memory immediately write the code to free the memory.</p>

<p>These functions can be found in the stdlib library</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdlib.h&gt;
</span><span class="kt">void</span> <span class="o">*</span><span class="nf">calloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">nmemb</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">malloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">realloc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
 
</code></pre></div></div>

<p>Examples</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
 <span class="kt">int</span> <span class="o">*</span><span class="n">int_values</span><span class="p">;</span> 
 <span class="n">int_values</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="nf">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">int_values</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">perror</span><span class="p">(</span><span class="s">"Failed to allocate space because"</span><span class="p">);</span>
  <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
 <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">values</span><span class="p">);</span>
 
</code></pre></div></div>

<p>Malloc (and calloc) will return a non-NULL value if the request for space has been successful, and NULL if it fails</p>

<h1 id="memory-allocation">Memory Allocation</h1>

<p>A memory allocator’s responsibility is to manage free blocks of memory. If you’ve never read a <strong>malloc</strong> implementation, you may have assumed that calling <strong>free</strong> simply causes memory to be released to the operating system. But acquiring memory from the OS has a cost, so allocators tend to keep free chunks around for a while for possible re-use before deciding to release them.</p>

<p>A very basic malloc implementation might use the linux system call <strong>sbrk</strong>(2) to acquire memory from the operating system and a [[linked list]] to store free chunks. That would make calls to free constant time, but <strong>malloc</strong> would be O(n).</p>

<p>the allocator needs to store metadata about each chunk it manages, such as its size, free/in-use status, free-list pointer(s), etc.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> header                pointer address  
    V                     V
    -----------------------------------------------------
    |                     |                             | 
    | struct malloc_chuck |                             | 
    |                     |                             | 
    -----------------------------------------------------

</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">malloc_chunk</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">malloc_chunk</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span> <span class="c1">// next pointer on free list</span>
  <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// the size of this chunk</span>
  <span class="kt">unsigned</span> <span class="n">free</span><span class="p">;</span> <span class="c1">// &gt; 0 if this pointer is free - useful for runtime assertions</span>
<span class="p">}</span>
 
<span class="k">struct</span> <span class="n">malloc_chunk</span> <span class="o">*</span>
<span class="nf">header</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="c1">//prts to memory subtract header to get start of header</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">malloc_chunk</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">malloc_chunk</span><span class="p">);</span> 
<span class="p">}</span>
</code></pre></div></div>

<h1 id="leaked-memory">Leaked Memory</h1>
<p>Once you have allocated memory, the problem is that the compiler can’t tell when you’re done with it, so you lose the automatic releasing. Your code is now responsible to decide when the variable is not needed anymore, and release it so the memory can be taken for other purposes. Forgetting to release a variable when you don’t need it will cause your program to consume more memory that it needs to. This situation is called a “leak”. The “leaked” memory cannot be used for anything until your program ends and the OS recovers all of its resources. Even nastier problems are possible if you release a heap variable by mistake before you are actually done with it.</p>

<h1 id="what-to-free">What to free?</h1>
<p>How does free know what to free? Malloc stores additional information about the size of the buffer in a few bytes before the actual data. Free reads that.</p>
<ul>
  <li>When you call malloc(), you specify the amount of memory to allocate. The amount of memory actually used is slightly more than this, and includes extra information that records (at least) how big the block is. When you call free(), it simply looks at the extra information to find out how big the block is</li>
  <li>The only thing that matters to free is getting the exact same address as what malloc returned.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">load_file</span><span class="p">()</span> 
<span class="p">{</span>   

 <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="s">"This is so data"</span><span class="p">;</span>   
 <span class="n">printf</span><span class="p">(</span><span class="s">"function: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span> 
 <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span> 
</code></pre></div></div>

<p>Will the above code leak memory? Should I have call free(data)? Why or why not?</p>
<ul>
  <li>You only need to free memory you allocate, memory on the heap.</li>
  <li>It cannot leak because you did not dynamically allocate it. data is a string literal and not a dynamically allocated array of characters.</li>
  <li>You can only leak memory on the heap</li>
  <li>Data itself, a pointer, is allocated on the stack</li>
</ul>

<h1 id="memcpy">memcpy()</h1>

<p>Copy block of memory
Copies the values of num bytes from the location pointed by source directly to the memory block pointed by destination.</p>

<p>The underlying type of the objects pointed by both the source and destination pointers are irrelevant for this function; The result is a binary copy of the data.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;string.h&gt;
</span><span class="kt">void</span> <span class="o">*</span> <span class="nf">memcpy</span> <span class="p">(</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">destination</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">source</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">num</span> <span class="p">);</span>
<span class="c1">// destination is returned.</span>
</code></pre></div></div>

<h2 id="example">Example</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* memcpy example */</span>
<span class="cp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">str1</span><span class="p">[]</span><span class="o">=</span><span class="s">"Sample string"</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">str2</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">str3</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
  <span class="n">memcpy</span> <span class="p">(</span><span class="n">str2</span><span class="p">,</span><span class="n">str1</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">str1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">memcpy</span> <span class="p">(</span><span class="n">str3</span><span class="p">,</span><span class="s">"copy successful"</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">"str1: %s</span><span class="se">\n</span><span class="s">str2: %s</span><span class="se">\n</span><span class="s">str3: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">str1</span><span class="p">,</span><span class="n">str2</span><span class="p">,</span><span class="n">str3</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="examples">Examples</h1>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pOutDMA</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_aligned_malloc</span><span class="p">(</span><span class="n">burst_size</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pInDMA</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_aligned_malloc</span><span class="p">(</span><span class="n">MAX_BURST</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pInDMA</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">_aligned_malloc</span><span class="p">(</span><span class="n">burst_size</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pOutDMASaved</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_aligned_malloc</span><span class="p">(</span><span class="n">burst_size</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
<span class="c1">// cast our DMA pointer to char *</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pOutDMA_8</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pOutDMA</span><span class="p">;</span>
<span class="c1">//	unsigned char *pInDMA_8 = (unsigned char *)pInDMA;</span>

<span class="n">printf</span><span class="p">(</span><span class="s">"Running Memtest</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="kt">uint16_t</span><span class="o">*</span> <span class="n">pOutDMABuffer16</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span><span class="o">*</span><span class="p">)</span><span class="n">pOutDMA_8</span><span class="p">;</span>

<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">pOutDmaBuffer32</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">pOutDMA_8</span><span class="p">;</span>
<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">pOutDmaSavedBuffer32</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pOutDMASaved</span><span class="p">;</span>
</code></pre></div></div>

<h1 id="references">References</h1>

<ul>
  <li>http://c-faq.com/malloc/freesize.html</li>
  <li>http://en.wikibooks.org/wiki/C_Programming/Memory_management</li>
</ul>

                </div>
            </main>
        </div><div class="right-side-bar">
<ul>
  <li><a href="#memory-management">Memory Management</a></li>
  <li><a href="#memory-allocation">Memory Allocation</a></li>
  <li><a href="#leaked-memory">Leaked Memory</a></li>
  <li><a href="#what-to-free">What to free?</a></li>
  <li><a href="#memcpy">memcpy()</a>
    <ul>
      <li><a href="#example">Example</a></li>
    </ul>
  </li>
  <li><a href="#examples">Examples</a></li>
  <li><a href="#references">References</a></li>
</ul>

</div></div><footer class="site-footer h-card">
  <data class="u-url" href="/documents/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">LFMUNOZ</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">LFMUNOZ</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/lfmunoz"><svg class="svg-icon"><use xlink:href="/documents/assets/minima-social-icons.svg#github"></use></svg> <span class="username">lfmunoz</span></a></li><li><a href="https://www.twitter.com/lfmunoz4"><svg class="svg-icon"><use xlink:href="/documents/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">lfmunoz4</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>articles, notes, and references</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>